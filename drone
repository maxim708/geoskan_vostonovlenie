import cv2
import numpy as np
import time
from pioneer_sdk import Pioneer  # Предполагается использование SDK Геоскан

def capture_and_save_image(camera, filename="drone_photo.jpg"):
    """
    Функция для захвата и сохранения изображения с камеры дрона

    Args:
        camera: объект камеры дрона
        filename: имя файла для сохранения
    """
    try:
        # Получение кадра с камеры
        frame = camera.get_frame()

        if frame is not None:
            # Декодирование изображения
            camera_frame = cv2.imdecode(np.frombuffer(frame, dtype=np.uint8), cv2.IMREAD_COLOR)

            if camera_frame is not None:
                # Сохранение изображения
                cv2.imwrite(filename, camera_frame)
                print(f"Фотография сохранена как: {filename}")
                return True
            else:
                print("Не удалось декодировать изображение")
                return False
        else:
            print("Кадр не получен")
            return False

    except Exception as e:
        print(f"Ошибка при сохранении файла: {e}")
        return False

def main():
    """
    Основная функция программы
    """
    print("Программа запущена. Фото будет сделано через 2 секунды...")

    try:
        # Подключение к дрону
        pioneer = Pioneer()
        pioneer.connect()  # или pioneer.connected() в зависимости от API

        # Получение объекта камеры
        camera = pioneer.get_camera()  # или другой метод доступа к камере

        # Ожидание 2 секунд перед снимком
        time.sleep(2)

        # Сделать автоматический снимок с нужным именем
        print("Делаем автоматический снимок...")
        capture_and_save_image(camera, "auto_capture.jpg")

        # Дополнительный режим: отображение видео в реальном времени
        print("Для выхода нажмите ESC в окне камеры...")

        while True:
            # Получение кадра и отображение
            frame = camera.get_frame()
            if frame is not None:
                camera_frame = cv2.imdecode(np.frombuffer(frame, dtype=np.uint8), cv2.IMREAD_COLOR)

                if camera_frame is not None:
                    cv2.imshow("Камера дрона", camera_frame)

            # Обработка нажатия клавиши ESC для выхода
            key = cv2.waitKey(1) & 0xFF
            if key == 27:  # ESC
                print("Выход по нажатию ESC")
                break

            # Небольшая задержка для снижения нагрузки на CPU
            time.sleep(0.02)

    except Exception as e:
        print(f"Ошибка в работе программы: {e}")

    finally:
        # Корректное завершение работы
        cv2.destroyAllWindows()

        try:
            pioneer.disconnect()  # или pioneer.close_connection()
            print("Соединение с дроном закрыто")
        except:
            pass

        print("Программа завершена")

if __name__ == "__main__":
    main()
